image: golang:1.21.4

stages:
  - build
  - lint
  - test
  - publish

build:
  stage: build
  script:
    - make build
  tags:
    - docker

fmt-check:
  stage: lint
  script:
    - make fmt-check
  only:
    - branches
  tags:
    - docker

lint:
  stage: lint
  script:
    - make lint
  only:
    - branches
  tags:
    - docker

static-check:
  stage: lint
  script:
    - make staticcheck
  only:
    - branches
  tags:
    - docker

vet:
  stage: lint
  script:
    - make vet
  only:
    - branches
  tags:
    - docker

unit-test:
  stage: test
  script:
    - make test
  only:
    - branches
  tags:
    - docker

coverage:
  stage: test
  coverage: /total:.*\d+\%|total:.*\d+.\d+\%/
  script:
    - make coverage-cobertura
  artifacts:
    reports:
      coverage_report: 
        coverage_format: cobertura
        path: build/coverage/cobertura.xml
  only:
    - branches
  tags:
    - docker

publish:
  stage: publish
  extends: build
  artifacts:
    paths:
      - build/jiracli
  tags:
    - docker
